/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package javadesimulator2;

import imgui.*;
import imgui.app.Application;
import imgui.app.Configuration;
import imgui.extension.imguifiledialog.ImGuiFileDialog;
import imgui.extension.imguifiledialog.flag.ImGuiFileDialogFlags;
import imgui.flag.ImGuiCol;
import imgui.flag.ImGuiColorEditFlags;
import imgui.flag.ImGuiConfigFlags;
import imgui.flag.ImGuiStyleVar;


import java.io.File;
import java.io.IOException;
import java.net.URISyntaxException;
import java.nio.file.Paths;
import java.util.Map;
import javadesimulator2.GUI.*;
import javadesimulator2.GUI.Schematic.Type;

public class App extends Application {
  @Override
  protected void configure(Configuration config) {
    config.setTitle("Dear ImGui is Awesome!");
  }

  private void setImGuiStyle() {
    ImGuiStyle style = ImGui.getStyle();
    style.setColor(ImGuiCol.Text, 1.00f, 1.00f, 1.00f, 1.00f);
    style.setColor(ImGuiCol.TextDisabled, 0.50f, 0.50f, 0.50f, 1.00f);
    style.setColor(ImGuiCol.WindowBg, 0.13f, 0.14f, 0.15f, 1.00f);
    style.setColor(ImGuiCol.ChildBg, 0.13f, 0.14f, 0.15f, 1.00f);
    style.setColor(ImGuiCol.PopupBg, 0.13f, 0.14f, 0.15f, 1.00f);
    style.setColor(ImGuiCol.Border, 0.43f, 0.43f, 0.50f, 0.50f);
    style.setColor(ImGuiCol.BorderShadow, 0.00f, 0.00f, 0.00f, 0.00f);
    style.setColor(ImGuiCol.FrameBg, 0.25f, 0.25f, 0.25f, 1.00f);
    style.setColor(ImGuiCol.FrameBgHovered, 0.38f, 0.38f, 0.38f, 1.00f);
    style.setColor(ImGuiCol.FrameBgActive, 0.67f, 0.67f, 0.67f, 0.39f);
    style.setColor(ImGuiCol.TitleBg, 0.08f, 0.08f, 0.09f, 1.00f);
    style.setColor(ImGuiCol.TitleBgActive, 0.08f, 0.08f, 0.09f, 1.00f);
    style.setColor(ImGuiCol.TitleBgCollapsed, 0.00f, 0.00f, 0.00f, 0.51f);
    style.setColor(ImGuiCol.MenuBarBg, 0.14f, 0.14f, 0.14f, 1.00f);
    style.setColor(ImGuiCol.ScrollbarBg, 0.02f, 0.02f, 0.02f, 0.53f);
    style.setColor(ImGuiCol.ScrollbarGrab, 0.31f, 0.31f, 0.31f, 1.00f);
    style.setColor(ImGuiCol.ScrollbarGrabHovered, 0.41f, 0.41f, 0.41f, 1.00f);
    style.setColor(ImGuiCol.ScrollbarGrabActive, 0.51f, 0.51f, 0.51f, 1.00f);
    style.setColor(ImGuiCol.CheckMark, 0.11f, 0.64f, 0.92f, 1.00f);
    style.setColor(ImGuiCol.SliderGrab, 0.11f, 0.64f, 0.92f, 1.00f);
    style.setColor(ImGuiCol.SliderGrabActive, 0.08f, 0.50f, 0.72f, 1.00f);
    style.setColor(ImGuiCol.Button, 0.25f, 0.25f, 0.25f, 1.00f);
    style.setColor(ImGuiCol.ButtonHovered, 0.38f, 0.38f, 0.38f, 1.00f);
    style.setColor(ImGuiCol.ButtonActive, 0.67f, 0.67f, 0.67f, 0.39f);
    style.setColor(ImGuiCol.Header, 0.22f, 0.22f, 0.22f, 1.00f);
    style.setColor(ImGuiCol.HeaderHovered, 0.25f, 0.25f, 0.25f, 1.00f);
    style.setColor(ImGuiCol.HeaderActive, 0.67f, 0.67f, 0.67f, 0.39f);
    style.setColor(ImGuiCol.Separator, 0.43f, 0.43f, 0.50f, 0.50f);
    style.setColor(ImGuiCol.SeparatorHovered, 0.41f, 0.42f, 0.44f, 1.00f);
    style.setColor(ImGuiCol.SeparatorActive, 0.26f, 0.59f, 0.98f, 0.95f);
    style.setColor(ImGuiCol.ResizeGrip, 0.00f, 0.00f, 0.00f, 0.00f);
    style.setColor(ImGuiCol.ResizeGripHovered, 0.29f, 0.30f, 0.31f, 0.67f);
    style.setColor(ImGuiCol.ResizeGripActive, 0.26f, 0.59f, 0.98f, 0.95f);
    style.setColor(ImGuiCol.Tab, 0.08f, 0.08f, 0.09f, 0.83f);
    style.setColor(ImGuiCol.TabHovered, 0.33f, 0.34f, 0.36f, 0.83f);
    style.setColor(ImGuiCol.TabActive, 0.23f, 0.23f, 0.24f, 1.00f);
    style.setColor(ImGuiCol.TabUnfocused, 0.08f, 0.08f, 0.09f, 1.00f);
    style.setColor(ImGuiCol.TabUnfocusedActive, 0.13f, 0.14f, 0.15f, 1.00f);
    style.setColor(ImGuiCol.DockingPreview, 0.26f, 0.59f, 0.98f, 0.70f);
    style.setColor(ImGuiCol.DockingEmptyBg, 0.20f, 0.20f, 0.20f, 1.00f);
    style.setColor(ImGuiCol.PlotLines, 0.61f, 0.61f, 0.61f, 1.00f);
    style.setColor(ImGuiCol.PlotLinesHovered, 1.00f, 0.43f, 0.35f, 1.00f);
    style.setColor(ImGuiCol.PlotHistogram, 0.90f, 0.70f, 0.00f, 1.00f);
    style.setColor(ImGuiCol.PlotHistogramHovered, 1.00f, 0.60f, 0.00f, 1.00f);
    style.setColor(ImGuiCol.TextSelectedBg, 0.26f, 0.59f, 0.98f, 0.35f);
    style.setColor(ImGuiCol.DragDropTarget, 0.11f, 0.64f, 0.92f, 1.00f);
    style.setColor(ImGuiCol.NavHighlight, 0.26f, 0.59f, 0.98f, 1.00f);
    style.setColor(ImGuiCol.NavWindowingHighlight, 1.00f, 1.00f, 1.00f, 0.70f);
    style.setColor(ImGuiCol.NavWindowingDimBg, 0.80f, 0.80f, 0.80f, 0.20f);
    style.setColor(ImGuiCol.ModalWindowDimBg, 0.80f, 0.80f, 0.80f, 0.35f);
    style.setGrabRounding(2.3f);
    style.setFrameRounding(2.3f);
  }

  private static byte[] loadFromResources(String name) {
    try {
      return java.nio.file.Files.readAllBytes(Paths.get(App.class.getResource(name).toURI()));
    } catch (IOException | URISyntaxException e) {
      throw new RuntimeException(e);
    }
  }

  @Override
  protected void initImGui(final Configuration config) {
    super.initImGui(config);
    final ImGuiIO io = ImGui.getIO();
    io.addConfigFlags(ImGuiConfigFlags.DockingEnable); // Enable Docking
    io.addConfigFlags(ImGuiConfigFlags.ViewportsEnable);

    // io.setIniFilename(null);
    final ImFontConfig fontConfig = new ImFontConfig();

    io.getFonts().addFontFromMemoryTTF(loadFromResources("/Roboto-Medium.ttf"), 15.0f, fontConfig);
    io.getFonts().build();
    setImGuiStyle();

    nodeEditor = new NodeEditor();
  }

  public void openFileDialog(String id, String title, String fileType) {
    ImGuiFileDialog.openDialog(id, title, fileType, ".", "", 1, 0, ImGuiFileDialogFlags.None);
  }

  public void save() {
    save(false);
  }

  public void save(boolean saveAs) {
    if (saveAs || nodeEditor.getLastSavePath() == null) {
      openFileDialog("browse-save", "Save As", nodeEditor.getSchematicType() == Type.ROOT ? ".jde2" : ".jde2c");
    } else {
      nodeEditor.serialize(nodeEditor.getLastSavePath());
    }
  }

  @Override
  public void process() {
    ImGui.dockSpaceOverViewport();

    ImGui.beginMainMenuBar();
    if (ImGui.beginMenu("File")) {

      if (ImGui.menuItem("save as")) {
        save(true);
      }

      if (ImGui.menuItem("save")) {
        save();
      }

      if (ImGui.menuItem("open")) {
        openFileDialog("browse-open", "Open", ".jde2,.jde2c");
      }

      if (ImGui.menuItem("new project")) {
        save();
        nodeEditor.newSchematic(Schematic.Type.ROOT);
        nodeEditor.setLastSavePath(null);
      }

      if (ImGui.menuItem("new component")) {
        save();
        nodeEditor.newSchematic(Schematic.Type.COMPONENT);
        nodeEditor.setLastSavePath(null);
      }

      if (ImGui.menuItem("optimize IDs")) {
        nodeEditor.optimizeIDs();
      }

      if (ImGui.menuItem("add custom component")) {
        openFileDialog("browse-custom", "Load Custom Node!", ".jde2c");
      }

      ImGui.endMenu();
    }

    ImGui.endMainMenuBar();

    if (ImGuiFileDialog.display("browse-save", ImGuiFileDialogFlags.None, 200, 400, 800, 600)) {
      if (ImGuiFileDialog.isOk()) {
        Map<String, String> filenames = ImGuiFileDialog.getSelection();
        if (ImGuiFileDialog.getFilePathName() != null
            && ImGuiFileDialog.getFilePathName().length() > 0) {
          String path = ImGuiFileDialog.getFilePathName();
          String extension = com.google.common.io.Files.getFileExtension(path);

          if (nodeEditor.getSchematicType() == Type.ROOT) {
            if (!extension.equals("jde2")) {
              System.out.println("path: " + path);
              path = path + ".jde2";
            }
          } else {
            if (!extension.equals("jde2c")) {
              System.out.println("path: " + path);
              path = path + ".jde2c";
            }
          }
          nodeEditor.serialize(path);
        } else if (filenames != null && filenames.size() > 0) {
          nodeEditor.serialize(filenames.values().stream().findFirst().get());
        }
      }

      ImGuiFileDialog.close();
    }

    if (ImGuiFileDialog.display("browse-open", ImGuiFileDialogFlags.None, 200, 400, 800, 600)) {
      if (ImGuiFileDialog.isOk()) {
        Map<String, String> filenames = ImGuiFileDialog.getSelection();
        if (filenames != null && filenames.size() > 0) {
          nodeEditor.load(filenames.values().stream().findFirst().get());
        }
      }
      ImGuiFileDialog.close();
    }

    if (ImGuiFileDialog.display("browse-custom", ImGuiFileDialogFlags.None, 200, 400, 800, 600)) {
      if (ImGuiFileDialog.isOk()) {
        Map<String, String> filenames = ImGuiFileDialog.getSelection();
        if (filenames != null && filenames.size() > 0) {
          nodeEditor.addCustomNode(new File(filenames.values().stream().findFirst().get()));
        }
      }
      ImGuiFileDialog.close();
    }

    nodeEditor.showSidebar(true);

    nodeEditor.show(true);
  }

  public static void main(String[] args) {
    launch(new App());
  }

  private NodeEditor nodeEditor = null;
}
